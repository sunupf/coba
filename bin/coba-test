#!/usr/bin/env node

(function(){
  var program = require('commander');
  var fs = require('fs-extra');
  var _ = require('lodash');
  var path = require('path');
  var errors = require('../lib/errors');
  var validate = require('../lib/validation');
  var spawn = require('child_process').spawn;
  var browserDriver,configFile;

  program
    .version('0.0.1')
    .arguments('<config> [browser]')
    .action(function(config,browser){
      configFile = config
      browserDriver = browser
    });

  program
    .on('--help', function() {
      require('../help/test')
    });

  program.parse(process.argv);
  if (typeof configFile === 'undefined') {
    console.error('No config file given!');
    require('../help/test')
  }else{
    var config;
    var scenario;
    try{
      config = require(process.cwd()+'/'+configFile);
    }catch(e){
      return console.log(e.message);
    }
    if(typeof browserDriver === 'undefined') {
      browserDriver = config.browser;
    }
    global.browserDriver = browserDriver;

    if(!_.size(config)){
      return console.log("There are errors on your config file, please check it");
    }

    var cobaTest;
    try{
      var testCases =  require(process.cwd()+"/"+config.data);

      // TODO require lib/test.js
      var Test = require('../lib/test')
      if(!_.isArray(config.browser)){
        throw new Error("browser name should be array")
      }
      _.forEach(config.browser, function(browser,index){
        var configSingleBrowser = Object.assign({},config);
        configSingleBrowser.browser = browser;
        var objTest = new Test(configSingleBrowser)
        _.forEach(testCases,function(data, key){
          // // start test, included record load time
          // console.log("ok");
          objTest.start(data);

          // require(process.cwd()+'/'+scenario)({
          //   'coba' : objTest,
          //   'data' : data
          // });

          // // start required test
          if(typeof config.beforeExec != "undefined"){
            objTest.startRequiredTest(process.cwd()+'/before.js',objTest,data)
          }else{
            console.log("before execution script not defined");
          }

          // require(process.cwd()+'/before.js')({
          //   'coba' : objTest,
          //   'data' : data
          // });
          if(typeof config.scenario != "undefined"){
            objTest.startExecution(process.cwd()+'/'+config.scenario, objTest, data)
          }else{
            throw new Error("Error, scenario is not defined")
          }

          // console.log(objTest.result);
          // console.log(objTest.log);
          // console.log("==========");
        });
        fs.writeJson(process.cwd()+"/log/"+browser+".json", objTest.log)
      });


    }catch(e){
      return console.log(e.message);
    }
  }
}).call(this)
